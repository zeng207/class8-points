<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>美女玛丽游戏（双关卡版）</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #222;
      font-family: "Microsoft YaHei", sans-serif;
      overflow: hidden;
      touch-action: none;
    }
    #container {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    canvas {
      display: block;
      max-width: 100%;
      max-height: 90vh;
      background: #88ddee;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
    }
    #ui {
      position: absolute;
      top: 10px;
      left: 10px;
      color: #fff;
      font-size: 16px;
      z-index: 10;
    }
    #instructions {
      position: absolute;
      top: 10px;
      right: 10px;
      color: rgba(255,255,255,0.7);
      font-size: 14px;
      z-index: 10;
    }
    #restartBtn {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 30px;
      background: #fff;
      border: none;
      border-radius: 30px;
      color: #333;
      font-size: 20px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      z-index: 20;
    }
    #restartBtn:hover {
      background: #f0f0f0;
      transform: translateX(-50%) scale(1.05);
      transition: all 0.2s;
    }
    #fullscreenBtn {
      position: absolute;
      bottom: 20px;
      right: 20px;
      padding: 10px 20px;
      background: rgba(0, 0, 0, 0.7);
      border: none;
      border-radius: 30px;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
      z-index: 20;
    }
    #gameOver {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.9);
      color: #fff;
      padding: 25px 40px;
      border-radius: 12px;
      text-align: center;
      font-size: 20px;
      z-index: 30;
      display: none;
    }
    #gameOver button {
      margin-top: 15px;
      padding: 10px 25px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 25px;
      font-size: 16px;
      cursor: pointer;
    }
    #gameOver button:hover {
      background: #45a049;
    }
  </style>
</head>
<body>
  <div id="container">
    <canvas id="game"></canvas>

    <div id="ui">金币: <span id="coinCount">0</span> | 关卡: <span id="levelDisplay">1</span></div>
    <div id="instructions">WASD/方向键移动跳跃</div>

    <button id="restartBtn">🎮 点击开始游戏</button>
    <button id="fullscreenBtn">⛶ 全屏</button>

    <div id="gameOver">
      <p id="gameOverMessage">准备开始冒险！</p>
      <button onclick="restartGame()">再玩一次</button>
    </div>
  </div>

  <script>
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    const uiCoin = document.getElementById("coinCount");
    const levelDisplay = document.getElementById("levelDisplay");
    const gameOverPanel = document.getElementById("gameOver");
    const gameOverMsg = document.getElementById("gameOverMessage");
    const restartBtn = document.getElementById("restartBtn");
    const fullscreenBtn = document.getElementById("fullscreenBtn");

    // 调整画布大小
    function resize() {
      const maxWidth = window.innerWidth * 0.95;
      const maxHeight = window.innerHeight * 0.9;
      const aspect = 640 / 400;
      let w = maxWidth;
      let h = w / aspect;
      if (h > maxHeight) h = maxHeight;
      w = h * aspect;

      canvas.width = 640;
      canvas.height = 400;
      canvas.style.width = w + "px";
      canvas.style.height = h + "px";
    }
    window.addEventListener("resize", resize);
    resize();

    // 键盘控制
    const keys = {};
    document.addEventListener("keydown", e => keys[e.key.toLowerCase()] = true);
    document.addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);

    // 游戏常量
    const GRAVITY = 0.6, JUMP = -12, MOVE_ACCEL = 0.6, FRICTION = 0.8, MAX_SPEED = 5;
    let worldOffset = 0, 
        gameOver = false, 
        coinsCollected = 0, 
        animationId = null,
        level = 1;

    let player, platforms, flag, coins, enemies;

    // 重启游戏
    function restartGame() {
      gameOver = false;  // ✅ 关键：重置游戏状态
      level = 1;
      coinsCollected = 0;
      updateUI();
      loadLevel(level);
      gameOverPanel.style.display = "none";
      if (animationId) cancelAnimationFrame(animationId);
      animationId = requestAnimationFrame(loop);
    }

    // 加载关卡
    function loadLevel(lv) {
      if (lv === 1) {
        player = { x: 50, y: 0, w: 30, h: 50, vx: 0, vy: 0, onGround: false };
        platforms = [
          { x: 0, y: 350, w: 2000, h: 50 },
          { x: 200, y: 300, w: 100, h: 20 },
          { x: 400, y: 250, w: 100, h: 20 },
          { x: 600, y: 200, w: 100, h: 20 },
          { x: 800, y: 150, w: 100, h: 20 },
        ];
        flag = { x: 1000, y: 100, h: 250 };
        coins = [
          { x: 250, y: 260, collected: false },
          { x: 450, y: 210, collected: false },
          { x: 650, y: 160, collected: false },
          { x: 850, y: 110, collected: false }
        ];
        enemies = [
          { x: 500, y: 320, w: 30, h: 30, vx: 1.5, alive: true }
        ];
      } else if (lv === 2) {
        player = { x: 100, y: 0, w: 30, h: 50, vx: 0, vy: 0, onGround: false };

        // 地面
        platforms = [
          { x: 0, y: 350, w: 5000, h: 50 }
        ];

        // 城墙主体
        const wallY = 250;
        platforms.push({ x: 800, y: wallY, w: 600, h: 100 }); // 墙高100

        // 垛口（女墙）
        for (let i = 0; i < 12; i++) {
          const x = 800 + i * 50;
          platforms.push({ x: x, y: wallY - 20, w: 30, h: 20 });
        }

        // 后续跳跃平台
        platforms.push({ x: 1600, y: 300, w: 80, h: 20 });
        platforms.push({ x: 1800, y: 250, w: 80, h: 20 });
        platforms.push({ x: 2000, y: 200, w: 80, h: 20 });
        platforms.push({ x: 2200, y: 150, w: 80, h: 20 });

        flag = { x: 2400, y: 100, h: 250 };

        coins = [
          { x: 900, y: wallY - 30, collected: false },
          { x: 1100, y: wallY - 30, collected: false },
          { x: 1300, y: wallY - 30, collected: false },
          { x: 1700, y: 260, collected: false },
          { x: 1900, y: 210, collected: false },
          { x: 2100, y: 160, collected: false },
          { x: 2300, y: 110, collected: false }
        ];

        enemies = [
          { x: 1000, y: 320, w: 30, h: 30, vx: 2, alive: true },
          { x: 1500, y: 320, w: 30, h: 30, vx: 2.5, alive: true },
          { x: 1900, y: 210, w: 30, h: 30, vx: 1.2, alive: true }
        ];
      }
    }

    // 更新UI
    function updateUI() {
      uiCoin.textContent = coinsCollected;
      levelDisplay.textContent = level;
    }

    // 游戏更新
    function update() {
      if (gameOver) return;

      if (keys["a"] || keys["arrowleft"]) player.vx -= MOVE_ACCEL;
      if (keys["d"] || keys["arrowright"]) player.vx += MOVE_ACCEL;
      if ((keys["w"] || keys["arrowup"] || keys[" "]) && player.onGround) {
        player.vy = JUMP;
        player.onGround = false;
      }

      player.vx *= FRICTION;
      if (player.vx > MAX_SPEED) player.vx = MAX_SPEED;
      if (player.vx < -MAX_SPEED) player.vx = -MAX_SPEED;
      player.vy += GRAVITY;
      player.x += player.vx;
      player.y += player.vy;
      player.onGround = false;

      // 碰撞检测
      for (let p of platforms) {
        if (player.x < p.x + p.w && player.x + player.w > p.x &&
            player.y < p.y + p.h && player.y + player.h > p.y) {
          if (player.vy >= 0 && player.y + player.h <= p.y + player.vy) {
            player.y = p.y - player.h;
            player.vy = 0;
            player.onGround = true;
          }
        }
      }

      worldOffset = Math.max(0, player.x - canvas.width / 2);

      // 吃金币
      for (let c of coins) {
        if (!c.collected &&
            player.x < c.x + 20 && player.x + player.w > c.x &&
            player.y < c.y + 20 && player.y + player.h > c.y) {
          c.collected = true;
          coinsCollected++;
          updateUI();
        }
      }

      // 敌人
      for (let e of enemies) {
        if (!e.alive) continue;
        e.x += e.vx;
        if (e.x < 800 || e.x > 1350) e.vx *= -1;
        if (e.x < 1400 || e.x > 2300) e.vx *= -1;

        if (player.x < e.x + e.w && player.x + player.w > e.x &&
            player.y < e.y + e.h && player.y + player.h > e.y) {
          if (player.vy > 0 && player.y + player.h - 10 < e.y) {
            e.alive = false;
            player.vy = JUMP / 2;
          } else {
            gameOver = true;
            showGameOver("你被怪物打败！");
          }
        }
      }

      // 通关
      if (player.x + player.w > flag.x - 10 && player.x < flag.x + 10) {
        if (level === 1) {
          level = 2;
          loadLevel(2);
          updateUI();
        } else {
          gameOver = true;
          showGameOver(`🎉 通关成功！金币: ${coinsCollected}`);
        }
      }

      if (player.y > canvas.height) {
        gameOver = true;
        showGameOver("掉下悬崖了！");
      }
    }

    // 坐标转换
    function worldToScreen(x, y) {
      return { x: x - worldOffset, y: y };
    }

    // 绘制
    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "#88ddee";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // 绘制平台
      ctx.fillStyle = "#654321";
      for (let p of platforms) {
        let s = worldToScreen(p.x, p.y);
        ctx.fillRect(s.x, s.y, p.w, p.h);
      }

      // ===== 第二关：城墙与门洞（底部完全贴地）=====
      if (level === 2) {
        const doorX = 1100;           // 门中心
        const doorWidth = 80;         // 门宽
        const archRadius = 40;        // 拱半径
        const doorHeight = 60;        // 门洞高

        const screenX = worldToScreen(doorX, 350).x;
        const doorBottomY = 350;      // 地面
        const doorTopY = doorBottomY - doorHeight +50; // 矩形顶部

        ctx.save();
        // 裁剪区域
        ctx.beginPath();
        ctx.rect(
          screenX - doorWidth / 2,
          doorTopY - archRadius,  // 拱顶
          doorWidth,
          doorHeight + archRadius
        );
        ctx.clip();

        // 挖洞
        ctx.globalCompositeOperation = "destination-out";

        // 半圆拱（从 doorTopY 向上画半圆）
        ctx.beginPath();
        ctx.arc(screenX, doorTopY, archRadius, 0, Math.PI, true);
        ctx.fill();

        // 矩形门洞（从 doorTopY 到地面）
        ctx.fillRect(screenX - doorWidth / 2, doorTopY, doorWidth, doorHeight);

        ctx.globalCompositeOperation = "source-over";
        ctx.restore();

        // 绘制“初二甲班”白色文字
        const signX = worldToScreen(1000, 230).x;
        ctx.fillStyle = "#fff";
        ctx.font = "bold 24px sans-serif";
        ctx.textAlign = "center";
        ctx.fillText("初二甲班", signX, 210);
      }

      // 旗杆
      let base = worldToScreen(flag.x, flag.y);
      ctx.fillStyle = "#444";
      ctx.fillRect(base.x - 3, base.y, 6, flag.h);
      ctx.fillStyle = "red";
      ctx.fillRect(base.x + 3, base.y, 40, 20);

      // 金币
      for (let c of coins) {
        if (!c.collected) {
          let pos = worldToScreen(c.x, c.y);
          ctx.fillStyle = "gold";
          ctx.beginPath();
          ctx.arc(pos.x + 10, pos.y + 10, 10, 0, Math.PI * 2);
          ctx.fill();
        }
      }

      // 敌人
      for (let e of enemies) {
        if (!e.alive) continue;
        let pos = worldToScreen(e.x, e.y);
        ctx.fillStyle = "brown";
        ctx.fillRect(pos.x, pos.y, e.w, e.h);
        ctx.fillStyle = "#fff";
        ctx.font = "12px sans-serif";
        ctx.fillText("怪", pos.x + 8, pos.y + 18);
      }

      // 玩家
      let pos = worldToScreen(player.x, player.y);
      ctx.fillStyle = "#ff99cc";
      ctx.fillRect(pos.x, pos.y, player.w, player.h);
      ctx.fillStyle = "#fff";
      ctx.font = "12px sans-serif";
      ctx.textAlign = "center";
      ctx.fillText("没", pos.x + player.w / 2, pos.y + 18);
      ctx.fillText("移", pos.x + player.w / 2, pos.y + 36);
    }

    // 显示结束面板
    function showGameOver(msg) {
      gameOverMsg.textContent = msg;
      gameOverPanel.style.display = "block";
      if (animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
      }
    }

    // 主循环
    function loop() {
      update();
      draw();
      animationId = requestAnimationFrame(loop);
    }

    // 按钮事件
    restartBtn.onclick = restartGame;
    fullscreenBtn.onclick = () => {
      if (document.fullscreenElement) {
        document.exitFullscreen();
        fullscreenBtn.textContent = "⛶ 全屏";
      } else {
        document.documentElement.requestFullscreen();
        fullscreenBtn.textContent = "⛶ 退出全屏";
      }
    };

    // 启动游戏
    restartGame();
  </script>
</body>
</html>
