<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>班级积分系统</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f4; }
    .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    input, button, select { padding: 8px; margin: 5px; border: 1px solid #ccc; border-radius: 4px; }
    button { background: #007bff; color: white; cursor: pointer; }
    button.secondary { background: #6c757d; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #007bff; color: white; }
    .form-group { margin: 15px 0; }
    .hidden { display: none; }
    .error { color: red; }
    .auto-saved { color: green; font-size: 12px; }
    .storage-warning { color: red; font-weight: bold; padding: 10px; background: #ffebee; border-radius: 4px; }
  </style>
</head>
<body>

<!-- 存储警告 -->
<div id="storageWarning" class="storage-warning hidden">
  ⚠️ 本地存储不可用！请关闭无痕模式，或使用服务器打开（不要双击文件）。
</div>

<!-- 登录页 -->
<div class="container" id="loginPage">
  <h2>📌 登录系统</h2>
  <div class="form-group">
    <label><input type="radio" name="role" value="teacher" checked> 教师登录（请输入密码）</label>
    <input type="password" id="teacherPassword" placeholder="密码" />
  </div>
  <div class="form-group">
    <label><input type="radio" name="role" value="student"> 学生登录（请输入姓名）</label>
    <input type="text" id="studentName" placeholder="请输入你的姓名" />
  </div>
  <button onclick="login()">登录</button>
  <p id="loginMsg" class="error"></p>
</div>

<!-- 主界面 -->
<div class="container hidden" id="mainPage">
  <h2>📊 班级积分管理系统</h2>
  <p>欢迎，<strong id="userDisplay"></strong>！</p>

  <!-- 教师功能区 -->
  <div id="teacherControls" class="hidden">
    <button onclick="addStudent()" style="margin: 10px 0;">➕ 添加学生</button>
    <button onclick="exportData()">📤 导出数据</button>
    <input type="file" id="importFile" accept=".json" style="margin: 10px 0;" />
    <button onclick="importData()">📥 导入数据</button>
    <button onclick="logout()" class="secondary">🚪 退出</button>
    <p class="auto-saved" id="saveStatus"></p>
  </div>

  <!-- 学生只读提示 -->
  <div id="studentControls" class="hidden">
    <button onclick="logout()" class="secondary">🚪 退出</button>
    <p class="auto-saved" id="saveStatus"></p>
  </div>

  <!-- 数据表格 -->
  <table id="scoreTable">
    <thead>
      <tr>
        <th>序号</th>
        <th>姓名</th>
        <th>周一</th>
        <th>周二</th>
        <th>周三</th>
        <th>周四</th>
        <th>周五</th>
        <th>总分</th>
        <th>排名</th>
      </tr>
    </thead>
    <tbody id="scoreBody"></tbody>
  </table>
</div>

<script>
// 检查 localStorage 是否可用
function checkStorage() {
  try {
    const test = "__storage_test__";
    localStorage.setItem(test, test);
    localStorage.removeItem(test);
    return true;
  } catch (e) {
    return false;
  }
}

if (!checkStorage()) {
  document.getElementById("storageWarning").classList.remove("hidden");
  alert("❌ 本地存储不可用！\n请：\n1. 关闭无痕模式\n2. 不要双击打开文件\n3. 使用服务器打开（如 VS Code Live Server）");
}

// 默认数据
const defaultData = {
  students: [],
  settings: {
    teacherPassword: "123456"
  }
};

// 初始化学生：张3 到 张45
function initStudents() {
  defaultData.students = [];
  for (let i = 3; i <= 45; i++) {
    defaultData.students.push({
      id: i - 2,
      name: `张${i}`,
      scores: { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 },
      total: 0,
      rank: 1
    });
  }
}

initStudents();

let appData = null;
let isTeacher = false;
let currentStudentName = null;
let saveTimeout = null;

// ============== 加载数据 ==============
function loadFromStorage() {
  try {
    const saved = localStorage.getItem("scoreAppData");
    if (saved) {
      const data = JSON.parse(saved);
      if (data.students && Array.isArray(data.students)) {
        appData = data;
        console.log("✅ 成功加载数据，学生数：", appData.students.length);
        return;
      }
    }
  } catch (e) {
    console.error("❌ 加载失败", e);
  }
  appData = JSON.parse(JSON.stringify(defaultData));
  console.log("🔄 使用默认数据");
}

// ============== 保存数据 ==============
function saveToStorage() {
  calculateRankings();
  try {
    localStorage.setItem("scoreAppData", JSON.stringify(appData));
    console.log("✅ 数据已保存，学生数：", appData.students.length);
    document.getElementById("saveStatus").textContent = "✅ 已自动保存";
    setTimeout(() => {
      const el = document.getElementById("saveStatus");
      if (el && el.textContent === "✅ 已自动保存") {
        el.textContent = "";
      }
    }, 2000);
  } catch (e) {
    console.error("❌ 保存失败", e);
    document.getElementById("saveStatus").textContent = "❌ 存储失败";
    alert("💾 存储失败！请检查是否为无痕模式");
  }
}

// ============== 自动保存（防抖） ==============
function autoSave() {
  if (saveTimeout) clearTimeout(saveTimeout);
  document.getElementById("saveStatus").textContent = "🔄 保存中...";
  saveTimeout = setTimeout(saveToStorage, 500);
}

// ============== 计算总分和排名 ==============
function calculateRankings() {
  appData.students.forEach(s => {
    s.total = (s.scores.mon || 0) + (s.scores.tue || 0) + (s.scores.wed || 0) + (s.scores.thu || 0) + (s.scores.fri || 0);
  });
  appData.students.sort((a, b) => (b.total || 0) - (a.total || 0));
  appData.students.forEach((s, idx) => {
    s.rank = idx + 1;
  });
}

// ============== 渲染表格 ==============
function renderTable() {
  const tbody = document.getElementById("scoreBody");
  tbody.innerHTML = "";

  const studentsToShow = isTeacher ? appData.students : appData.students.filter(s => s.name === currentStudentName);

  studentsToShow.forEach((s, index) => {
    const tr = document.createElement("tr");

    // 姓名单元格
    const nameCell = isTeacher
      ? `<td><input type="text" value="${s.name}" oninput="updateName(${index}, this.value)" style="width:60px;text-align:center;" /></td>`
      : `<td>${s.name}</td>`;

    // 分数单元格
    const days = ['mon', 'tue', 'wed', 'thu', 'fri'];
    const scoreCells = days.map(day => 
      isTeacher
        ? `<td><input type="number" value="${s.scores[day] || 0}" min="0" max="100" oninput="updateScore(${index}, '${day}', this.valueAsNumber)" style="width:50px;text-align:center;" /></td>`
        : `<td>${s.scores[day] || 0}</td>`
    ).join('');

    tr.innerHTML = `
      <td>${s.id}</td>
      ${nameCell}
      ${scoreCells}
      <td>${s.total || 0}</td>
      <td>${s.rank || 1}</td>
    `;
    tbody.appendChild(tr);
  });
}

// ============== 更新姓名 ==============
function updateName(index, newName) {
  if (!newName || !newName.trim()) return;
  appData.students[index].name = newName.trim();
  autoSave();
}

// ============== 更新分数 ==============
function updateScore(index, day, value) {
  if (value < 0) value = 0;
  if (value > 100) value = 100;
  appData.students[index].scores[day] = value;
  autoSave();
}

// ============== 添加学生 ==============
function addStudent() {
  const name = prompt("请输入新学生姓名：");
  if (!name || !name.trim()) {
    alert("姓名不能为空");
    return;
  }
  if (appData.students.some(s => s.name === name.trim())) {
    alert("❌ 该姓名已存在！");
    return;
  }
  const newId = Math.max(0, ...appData.students.map(s => s.id)) + 1;
  appData.students.push({
    id: newId,
    name: name.trim(),
    scores: { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 },
    total: 0,
    rank: 1
  });
  autoSave();
  renderTable();
}

// ============== 登录 ==============
function login() {
  loadFromStorage();

  const role = document.querySelector('input[name="role"]:checked').value;
  const pwd = document.getElementById("teacherPassword").value;
  const name = document.getElementById("studentName").value.trim();
  const msgEl = document.getElementById("loginMsg");
  msgEl.textContent = "";

  if (role === "teacher") {
    if (pwd === appData.settings.teacherPassword) {
      isTeacher = true;
      currentStudentName = null;
      showMainPage("教师");
      document.getElementById("teacherControls").classList.remove("hidden");
      document.getElementById("studentControls").classList.add("hidden");
    } else {
      msgEl.textContent = "❌ 密码错误！";
    }
  } else if (role === "student") {
    if (appData.students.some(s => s.name === name)) {
      isTeacher = false;
      currentStudentName = name;
      showMainPage(`学生（${name}）`);
      document.getElementById("teacherControls").classList.add("hidden");
      document.getElementById("studentControls").classList.remove("hidden");
    } else {
      msgEl.textContent = "❌ 未找到该学生";
    }
  }
}

// ============== 显示主页面 ==============
function showMainPage(user) {
  document.getElementById("loginPage").classList.add("hidden");
  document.getElementById("mainPage").classList.remove("hidden");
  document.getElementById("userDisplay").textContent = user;
  renderTable();
}

// ============== 导出 ==============
function exportData() {
  loadFromStorage();
  const dataStr = JSON.stringify(appData, null, 2);
  const blob = new Blob([dataStr], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `score_data_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
}

// ============== 导入 ==============
async function importData() {
  const file = document.getElementById("importFile").files[0];
  if (!file) return alert("请选择文件");

  try {
    const text = await file.text();
    const imported = JSON.parse(text);
    if (imported.students && Array.isArray(imported.students)) {
      appData = imported;
      saveToStorage();
      renderTable();
      alert(`✅ 导入成功，共 ${appData.students.length} 名学生`);
    } else {
      alert("❌ 数据格式错误");
    }
  } catch (e) {
    alert("❌ 导入失败：" + e.message);
  }
  document.getElementById("importFile").value = "";
}

// ============== 退出 ==============
function logout() {
  if (confirm("确定要退出吗？")) {
    document.getElementById("mainPage").classList.add("hidden");
    document.getElementById("loginPage").classList.remove("hidden");
    document.getElementById("teacherPassword").value = "";
    document.getElementById("studentName").value = "";
    isTeacher = false;
    currentStudentName = null;
    if (saveTimeout) clearTimeout(saveTimeout);
  }
}
</script>
</body>
</html>
