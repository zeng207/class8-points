<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ç­çº§ç§¯åˆ†ç³»ç»Ÿ</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f4; }
    .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    input, button, select { padding: 8px; margin: 5px; border: 1px solid #ccc; border-radius: 4px; }
    button { background: #007bff; color: white; cursor: pointer; }
    button.secondary { background: #6c757d; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #007bff; color: white; }
    .form-group { margin: 15px 0; }
    .hidden { display: none; }
    .error { color: red; }
    .auto-saved { color: green; font-size: 12px; }
    .storage-warning { color: red; font-weight: bold; padding: 10px; background: #ffebee; border-radius: 4px; }
  </style>
</head>
<body>

<!-- å­˜å‚¨è­¦å‘Š -->
<div id="storageWarning" class="storage-warning hidden">
  âš ï¸ æœ¬åœ°å­˜å‚¨ä¸å¯ç”¨ï¼è¯·å…³é—­æ— ç—•æ¨¡å¼ï¼Œæˆ–ä½¿ç”¨æœåŠ¡å™¨æ‰“å¼€ï¼ˆä¸è¦åŒå‡»æ–‡ä»¶ï¼‰ã€‚
</div>

<!-- ç™»å½•é¡µ -->
<div class="container" id="loginPage">
  <h2>ğŸ“Œ ç™»å½•ç³»ç»Ÿ</h2>
  <div class="form-group">
    <label><input type="radio" name="role" value="teacher" checked> æ•™å¸ˆç™»å½•ï¼ˆè¯·è¾“å…¥å¯†ç ï¼‰</label>
    <input type="password" id="teacherPassword" placeholder="å¯†ç " />
  </div>
  <div class="form-group">
    <label><input type="radio" name="role" value="student"> å­¦ç”Ÿç™»å½•ï¼ˆè¯·è¾“å…¥å§“åï¼‰</label>
    <input type="text" id="studentName" placeholder="è¯·è¾“å…¥ä½ çš„å§“å" />
  </div>
  <button onclick="login()">ç™»å½•</button>
  <p id="loginMsg" class="error"></p>
</div>

<!-- ä¸»ç•Œé¢ -->
<div class="container hidden" id="mainPage">
  <h2>ğŸ“Š ç­çº§ç§¯åˆ†ç®¡ç†ç³»ç»Ÿ</h2>
  <p>æ¬¢è¿ï¼Œ<strong id="userDisplay"></strong>ï¼</p>

  <!-- æ•™å¸ˆåŠŸèƒ½åŒº -->
  <div id="teacherControls" class="hidden">
    <button onclick="addStudent()" style="margin: 10px 0;">â• æ·»åŠ å­¦ç”Ÿ</button>
    <button onclick="exportData()">ğŸ“¤ å¯¼å‡ºæ•°æ®</button>
    <input type="file" id="importFile" accept=".json" style="margin: 10px 0;" />
    <button onclick="importData()">ğŸ“¥ å¯¼å…¥æ•°æ®</button>
    <button onclick="logout()" class="secondary">ğŸšª é€€å‡º</button>
    <p class="auto-saved" id="saveStatus"></p>
  </div>

  <!-- å­¦ç”Ÿåªè¯»æç¤º -->
  <div id="studentControls" class="hidden">
    <button onclick="logout()" class="secondary">ğŸšª é€€å‡º</button>
    <p class="auto-saved" id="saveStatus"></p>
  </div>

  <!-- æ•°æ®è¡¨æ ¼ -->
  <table id="scoreTable">
    <thead>
      <tr>
        <th>åºå·</th>
        <th>å§“å</th>
        <th>å‘¨ä¸€</th>
        <th>å‘¨äºŒ</th>
        <th>å‘¨ä¸‰</th>
        <th>å‘¨å››</th>
        <th>å‘¨äº”</th>
        <th>æ€»åˆ†</th>
        <th>æ’å</th>
      </tr>
    </thead>
    <tbody id="scoreBody"></tbody>
  </table>
</div>

<script>
// æ£€æŸ¥ localStorage æ˜¯å¦å¯ç”¨
function checkStorage() {
  try {
    const test = "__storage_test__";
    localStorage.setItem(test, test);
    localStorage.removeItem(test);
    return true;
  } catch (e) {
    return false;
  }
}

if (!checkStorage()) {
  document.getElementById("storageWarning").classList.remove("hidden");
  alert("âŒ æœ¬åœ°å­˜å‚¨ä¸å¯ç”¨ï¼\nè¯·ï¼š\n1. å…³é—­æ— ç—•æ¨¡å¼\n2. ä¸è¦åŒå‡»æ‰“å¼€æ–‡ä»¶\n3. ä½¿ç”¨æœåŠ¡å™¨æ‰“å¼€ï¼ˆå¦‚ VS Code Live Serverï¼‰");
}

// é»˜è®¤æ•°æ®
const defaultData = {
  students: [],
  settings: {
    teacherPassword: "123456"
  }
};

// åˆå§‹åŒ–å­¦ç”Ÿï¼šå¼ 3 åˆ° å¼ 45
function initStudents() {
  defaultData.students = [];
  for (let i = 3; i <= 45; i++) {
    defaultData.students.push({
      id: i - 2,
      name: `å¼ ${i}`,
      scores: { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 },
      total: 0,
      rank: 1
    });
  }
}

initStudents();

let appData = null;
let isTeacher = false;
let currentStudentName = null;
let saveTimeout = null;

// ============== åŠ è½½æ•°æ® ==============
function loadFromStorage() {
  try {
    const saved = localStorage.getItem("scoreAppData");
    if (saved) {
      const data = JSON.parse(saved);
      if (data.students && Array.isArray(data.students)) {
        appData = data;
        console.log("âœ… æˆåŠŸåŠ è½½æ•°æ®ï¼Œå­¦ç”Ÿæ•°ï¼š", appData.students.length);
        return;
      }
    }
  } catch (e) {
    console.error("âŒ åŠ è½½å¤±è´¥", e);
  }
  appData = JSON.parse(JSON.stringify(defaultData));
  console.log("ğŸ”„ ä½¿ç”¨é»˜è®¤æ•°æ®");
}

// ============== ä¿å­˜æ•°æ® ==============
function saveToStorage() {
  calculateRankings();
  try {
    localStorage.setItem("scoreAppData", JSON.stringify(appData));
    console.log("âœ… æ•°æ®å·²ä¿å­˜ï¼Œå­¦ç”Ÿæ•°ï¼š", appData.students.length);
    document.getElementById("saveStatus").textContent = "âœ… å·²è‡ªåŠ¨ä¿å­˜";
    setTimeout(() => {
      const el = document.getElementById("saveStatus");
      if (el && el.textContent === "âœ… å·²è‡ªåŠ¨ä¿å­˜") {
        el.textContent = "";
      }
    }, 2000);
  } catch (e) {
    console.error("âŒ ä¿å­˜å¤±è´¥", e);
    document.getElementById("saveStatus").textContent = "âŒ å­˜å‚¨å¤±è´¥";
    alert("ğŸ’¾ å­˜å‚¨å¤±è´¥ï¼è¯·æ£€æŸ¥æ˜¯å¦ä¸ºæ— ç—•æ¨¡å¼");
  }
}

// ============== è‡ªåŠ¨ä¿å­˜ï¼ˆé˜²æŠ–ï¼‰ ==============
function autoSave() {
  if (saveTimeout) clearTimeout(saveTimeout);
  document.getElementById("saveStatus").textContent = "ğŸ”„ ä¿å­˜ä¸­...";
  saveTimeout = setTimeout(saveToStorage, 500);
}

// ============== è®¡ç®—æ€»åˆ†å’Œæ’å ==============
function calculateRankings() {
  appData.students.forEach(s => {
    s.total = (s.scores.mon || 0) + (s.scores.tue || 0) + (s.scores.wed || 0) + (s.scores.thu || 0) + (s.scores.fri || 0);
  });
  appData.students.sort((a, b) => (b.total || 0) - (a.total || 0));
  appData.students.forEach((s, idx) => {
    s.rank = idx + 1;
  });
}

// ============== æ¸²æŸ“è¡¨æ ¼ ==============
function renderTable() {
  const tbody = document.getElementById("scoreBody");
  tbody.innerHTML = "";

  const studentsToShow = isTeacher ? appData.students : appData.students.filter(s => s.name === currentStudentName);

  studentsToShow.forEach((s, index) => {
    const tr = document.createElement("tr");

    // å§“åå•å…ƒæ ¼
    const nameCell = isTeacher
      ? `<td><input type="text" value="${s.name}" oninput="updateName(${index}, this.value)" style="width:60px;text-align:center;" /></td>`
      : `<td>${s.name}</td>`;

    // åˆ†æ•°å•å…ƒæ ¼
    const days = ['mon', 'tue', 'wed', 'thu', 'fri'];
    const scoreCells = days.map(day => 
      isTeacher
        ? `<td><input type="number" value="${s.scores[day] || 0}" min="0" max="100" oninput="updateScore(${index}, '${day}', this.valueAsNumber)" style="width:50px;text-align:center;" /></td>`
        : `<td>${s.scores[day] || 0}</td>`
    ).join('');

    tr.innerHTML = `
      <td>${s.id}</td>
      ${nameCell}
      ${scoreCells}
      <td>${s.total || 0}</td>
      <td>${s.rank || 1}</td>
    `;
    tbody.appendChild(tr);
  });
}

// ============== æ›´æ–°å§“å ==============
function updateName(index, newName) {
  if (!newName || !newName.trim()) return;
  appData.students[index].name = newName.trim();
  autoSave();
}

// ============== æ›´æ–°åˆ†æ•° ==============
function updateScore(index, day, value) {
  if (value < 0) value = 0;
  if (value > 100) value = 100;
  appData.students[index].scores[day] = value;
  autoSave();
}

// ============== æ·»åŠ å­¦ç”Ÿ ==============
function addStudent() {
  const name = prompt("è¯·è¾“å…¥æ–°å­¦ç”Ÿå§“åï¼š");
  if (!name || !name.trim()) {
    alert("å§“åä¸èƒ½ä¸ºç©º");
    return;
  }
  if (appData.students.some(s => s.name === name.trim())) {
    alert("âŒ è¯¥å§“åå·²å­˜åœ¨ï¼");
    return;
  }
  const newId = Math.max(0, ...appData.students.map(s => s.id)) + 1;
  appData.students.push({
    id: newId,
    name: name.trim(),
    scores: { mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 },
    total: 0,
    rank: 1
  });
  autoSave();
  renderTable();
}

// ============== ç™»å½• ==============
function login() {
  loadFromStorage();

  const role = document.querySelector('input[name="role"]:checked').value;
  const pwd = document.getElementById("teacherPassword").value;
  const name = document.getElementById("studentName").value.trim();
  const msgEl = document.getElementById("loginMsg");
  msgEl.textContent = "";

  if (role === "teacher") {
    if (pwd === appData.settings.teacherPassword) {
      isTeacher = true;
      currentStudentName = null;
      showMainPage("æ•™å¸ˆ");
      document.getElementById("teacherControls").classList.remove("hidden");
      document.getElementById("studentControls").classList.add("hidden");
    } else {
      msgEl.textContent = "âŒ å¯†ç é”™è¯¯ï¼";
    }
  } else if (role === "student") {
    if (appData.students.some(s => s.name === name)) {
      isTeacher = false;
      currentStudentName = name;
      showMainPage(`å­¦ç”Ÿï¼ˆ${name}ï¼‰`);
      document.getElementById("teacherControls").classList.add("hidden");
      document.getElementById("studentControls").classList.remove("hidden");
    } else {
      msgEl.textContent = "âŒ æœªæ‰¾åˆ°è¯¥å­¦ç”Ÿ";
    }
  }
}

// ============== æ˜¾ç¤ºä¸»é¡µé¢ ==============
function showMainPage(user) {
  document.getElementById("loginPage").classList.add("hidden");
  document.getElementById("mainPage").classList.remove("hidden");
  document.getElementById("userDisplay").textContent = user;
  renderTable();
}

// ============== å¯¼å‡º ==============
function exportData() {
  loadFromStorage();
  const dataStr = JSON.stringify(appData, null, 2);
  const blob = new Blob([dataStr], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `score_data_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
}

// ============== å¯¼å…¥ ==============
async function importData() {
  const file = document.getElementById("importFile").files[0];
  if (!file) return alert("è¯·é€‰æ‹©æ–‡ä»¶");

  try {
    const text = await file.text();
    const imported = JSON.parse(text);
    if (imported.students && Array.isArray(imported.students)) {
      appData = imported;
      saveToStorage();
      renderTable();
      alert(`âœ… å¯¼å…¥æˆåŠŸï¼Œå…± ${appData.students.length} åå­¦ç”Ÿ`);
    } else {
      alert("âŒ æ•°æ®æ ¼å¼é”™è¯¯");
    }
  } catch (e) {
    alert("âŒ å¯¼å…¥å¤±è´¥ï¼š" + e.message);
  }
  document.getElementById("importFile").value = "";
}

// ============== é€€å‡º ==============
function logout() {
  if (confirm("ç¡®å®šè¦é€€å‡ºå—ï¼Ÿ")) {
    document.getElementById("mainPage").classList.add("hidden");
    document.getElementById("loginPage").classList.remove("hidden");
    document.getElementById("teacherPassword").value = "";
    document.getElementById("studentName").value = "";
    isTeacher = false;
    currentStudentName = null;
    if (saveTimeout) clearTimeout(saveTimeout);
  }
}
</script>
</body>
</html>
